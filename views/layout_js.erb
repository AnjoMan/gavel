<script type="text/javascript">
  function Complaint() {
    this.streetAddress = "";
    this.city = "";
    this.complaint = "";
    this.comments = "";

    this.formattedComplaint = function () {
      var formatted = this.complaint + " at " + this.streetAddress + " in " + this.city + ".";
      if (this.comments != '')
        formatted += " " + this.comments;
      return formatted;
    }

    this.complaintDefinition = function() {
      var definitions = {
        "Snow and Ice" : "(snow or ice that hasn't been cleared within 24 hours of a snow fall)",
        "Dog feces" : "(accumulation in residential backyard)",
        "Exterior Property Maintenance" : "(roof, windows, doors etc. that are broken or in need of major repair)",
        "Garbage and Debris" : "(residential and/or commercial properties)",
        "Garbage dumping" : "(garbage dumped on public properties or back alleys, ditches etc.)",
        "Illegal use of property" : "(zoning)",
        "Interior Property Maintenance" : "(rental properties) ",
        "Long grass" : "(more than 8 inches)",
        "Noise" : "(only noise during the day due to construction projects, large machines or equipment etc.)",
      }
      return definitions[this.complaint] || '';
    }

  }

	$(function() {
    // push.js provides a callback on push
    window.addEventListener('push', pushListener);
    function pushListener(detail) {
      var destinationURL = detail['detail']['state']['url'];
      destinationURL = destinationURL.replace(/http:\/\/.*\//,''); // get the pure destination only
      handleViewChange(destinationURL);
    }

    function handleViewChange(view) {
      switch (view) {
        case 'settings':
          settingsViewLoaded();
          break;
        case '':
          indexViewLoaded();
          break;
        case 'confirm':
          confirmViewLoaded();
          break;
      }
    }

    function settingsViewLoaded() {
      // load from local storage
      $("form#settings").find('input, select').each(function(index,item) {
        $(item).val(localStorage[$(item).attr('name')]);
      });

      $("#save").on('click', function(e) {
        $("form#settings").find('input, select').each(function(index,item) {
          localStorage[$(item).attr('name')] = $(item).val();
        });
      });
    }

    function fillInAddress(position) {
      var latitude = position.coords.latitude;
      var longitude = position.coords.longitude;

      $.getJSON('http://maps.googleapis.com/maps/api/geocode/json?sensor=true&latlng=' + latitude + ',' + longitude, function(data){
        var streetNumber = data['results'][0]['address_components'][0]['long_name'];
        var streetName = data['results'][0]['address_components'][1]['long_name'];
        $("#address").val(streetNumber + ' ' + streetName);
      });
    }

    function indexViewLoaded() {
      navigator.geolocation.getCurrentPosition(fillInAddress);

      // when the user taps next, save the current form field values in the Complaint object
      $("#next-complaint").on('tap', function(e) {
        $("form#complaint").find('input, select, textarea').each(function(index,item) {
          activeComplaint[$(item).attr('name')] = $(item).val();
        });
      });
    }

    function confirmViewLoaded() {
      $("#complaint").html(activeComplaint.complaint);
      if (activeComplaint.complaintDefinition() != '')
        $("#complaint").html($("#complaint").html() + " " + activeComplaint.complaintDefinition());
      $("#streetAddress").html(activeComplaint.streetAddress + ", " + activeComplaint.city);
      if (activeComplaint.comments != '') {
        $("#comments-label").show();
        $("#comments").show();
        $("#comments").html(activeComplaint.comments);
      } else {
        $("#comments-label").hide();
        $("#comments").hide();
      }
    }

    var activeComplaint = new Complaint();
    indexViewLoaded();
	});
</script>
